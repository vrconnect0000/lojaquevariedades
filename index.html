<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TERMINAL | Anonymous Society</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --primary: #00ff41; 
            --primary-dim: #003b11;
            --bg: #050505; 
            --card: #0a0a0a;
            --text: #00ff41;
            --accent: #00d2ff;
            --header-h: 50px;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Fira Code', monospace; 
            background: var(--bg); 
            color: var(--text);
            margin: 0; 
            height: 100vh;
            display: flex;
            justify-content: center;
            overflow: hidden;
        }

        body::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 100;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        #chat-container { 
            width: 100%;
            max-width: 800px; 
            height: 100%; 
            background: var(--card); 
            display: flex; 
            flex-direction: column; 
            position: relative;
            border-left: 1px solid var(--primary-dim);
            border-right: 1px solid var(--primary-dim);
        }

        #header { 
            height: var(--header-h);
            padding: 0 15px; 
            border-bottom: 1px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.9);
            z-index: 50;
        }

        .status-container { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; }
        .status-dot { width: 8px; height: 8px; background: var(--primary); border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

        #online-count { font-size: 0.7rem; color: var(--accent); }

        #mensagens { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            padding-bottom: 100px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            background: radial-gradient(circle, #0a1a0a 0%, #050505 100%);
        }

        .msg { 
            padding: 8px 12px; 
            border: 1px solid var(--primary-dim);
            max-width: 85%; 
            font-size: 0.85rem;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

        .minha { align-self: flex-end; border-color: var(--primary); background: rgba(0, 255, 65, 0.05); color: #fff; }
        .outra { align-self: flex-start; border-color: var(--accent); background: rgba(0, 210, 255, 0.05); }

        .nome { font-size: 0.65rem; font-weight: bold; margin-bottom: 4px; display: block; }
        .foto { max-width: 100%; border: 1px solid var(--primary); margin-top: 10px; }
        audio { width: 100%; max-width: 200px; margin-top: 10px; filter: invert(1); }

        #controles { 
            position: absolute;
            bottom: 0; left: 0; right: 0;
            padding: 10px 15px; 
            background: #000; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            border-top: 1px solid var(--primary);
            z-index: 60;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }

        input[type="text"] { 
            flex: 1; 
            padding: 10px; 
            border: 1px solid var(--primary-dim); 
            background: #000; 
            color: var(--primary); 
            outline: none;
            font-size: 16px; 
            font-family: 'Fira Code', monospace;
        }

        .btn-icon { background: none; border: none; cursor: pointer; color: var(--primary); font-size: 1.3rem; }
        
        #btn-enviar { 
            background: var(--primary); 
            color: #000; 
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Fira Code', monospace;
        }

        #hidden-file { display: none; }
    </style>
</head>
<body>

<div id="chat-container">
    <div id="header">
        <div class="status-container">
            <div class="status-dot"></div>
            <span>ROOT@NETWORK:~$</span>
        </div>
        <div id="online-count">ANONYMOUS ONLINE: --</div>
    </div>
    
    <div id="mensagens"></div>

    <div id="controles">
        <label for="hidden-file" class="btn-icon">üìÅ</label>
        <input type="file" id="hidden-file" accept="image/*">
        <button id="btn-audio" class="btn-icon">üéôÔ∏è</button>
        <input type="text" id="input-msg" placeholder="Comando..." autocomplete="off">
        <button id="btn-enviar">SEND</button>
    </div>
</div>

<script>
    // Configura√ß√µes do Supabase
    const SUPABASE_URL = "https://zkhradhpwakvtgsilsyj.supabase.co";
    const SUPABASE_KEY = "sb_publishable_UrUxPsPD3XBTANwwp3tZOA_-REppnf3";
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Identidade do usu√°rio
    let nome = localStorage.getItem('hacker_alias');
    if (!nome) {
        let alias = prompt("DEFINA SEU ALIAS (CODINOME):");
        nome = alias && alias.trim() !== "" ? alias : "GHOST_" + Math.random().toString(36).substring(7).toUpperCase();
        localStorage.setItem('hacker_alias', nome);
    }

    const divMsgs = document.getElementById('mensagens');
    const inputMsg = document.getElementById('input-msg');
    const btnEnviar = document.getElementById('btn-enviar');

    // Fun√ß√£o para renderizar as mensagens na tela
    function renderizarMensagem(d) {
        const item = document.createElement('div');
        const eMeu = d.nome === nome;
        item.className = `msg ${eMeu ? 'minha' : 'outra'}`;
        
        let conteudo = `<span class="nome" style="color: ${eMeu ? 'var(--primary)' : 'var(--accent)'}">[${d.nome}]</span>`;
        if (d.tipo === 'texto') conteudo += `<div>${d.valor}</div>`;
        if (d.tipo === 'imagem') conteudo += `<img src="${d.valor}" class="foto">`;
        if (d.tipo === 'audio') conteudo += `<audio src="${d.valor}" controls></audio>`;
        
        item.innerHTML = conteudo;
        divMsgs.appendChild(item);
        divMsgs.scrollTop = divMsgs.scrollHeight;
    }

    // --- L√ìGICA DE REALTIME COM SUPABASE ---

    // Canal de comunica√ß√£o
    const channel = _supabase.channel('room-1', {
        config: { broadcast: { self: true }, presence: { key: nome } }
    });

    // Escutar mensagens recebidas
    channel
    .on('broadcast', { event: 'shout' }, (payload) => {
        renderizarMensagem(payload.payload);
    })
    // Monitorar quem est√° online (Presence)
    .on('presence', { event: 'sync' }, () => {
        const state = channel.presenceState();
        document.getElementById('online-count').innerText = `ANONYMOUS ONLINE: ${Object.keys(state).length}`;
    })
    .subscribe(async (status) => {
        if (status === 'SUBSCRIBED') {
            await channel.track({ online_at: new Date().toISOString() });
        }
    });

    // Fun√ß√£o para enviar
    const enviarMensagem = (tipo, valor) => {
        const dados = { nome, tipo, valor, timestamp: Date.now() };
        channel.send({
            type: 'broadcast',
            event: 'shout',
            payload: dados
        });
    };

    btnEnviar.onclick = () => {
        const val = inputMsg.value.trim();
        if (!val) return;
        enviarMensagem('texto', val);
        inputMsg.value = '';
    };

    inputMsg.onkeypress = (e) => { if(e.key === 'Enter') btnEnviar.onclick(); };

    // Upload de Imagem (Convertendo para Base64 para o broadcast)
    document.getElementById('hidden-file').onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const maxW = 400; // Reduzi o tamanho para o broadcast n√£o ficar pesado
                const scale = maxW / img.width;
                canvas.width = maxW;
                canvas.height = img.height * scale;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                enviarMensagem('imagem', canvas.toDataURL('image/jpeg', 0.5));
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };

    // √Åudio
    let mediaRecorder;
    document.getElementById('btn-audio').onclick = async function() {
        try {
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                let chunks = [];
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'audio/ogg' });
                    const r = new FileReader();
                    r.onload = (e) => enviarMensagem('audio', e.target.result);
                    r.readAsDataURL(blob);
                };
                mediaRecorder.start();
                this.innerText = "üî¥";
            } else {
                mediaRecorder.stop();
                this.innerText = "üéôÔ∏è";
            }
        } catch (err) {
            alert("Erro ao acessar microfone.");
        }
    };
</script>
</body>
</html>
